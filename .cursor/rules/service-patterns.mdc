---
globs: src/services/*.ts
---

# Паттерны сервисов в Crypto Checker

## Структура сервиса

Каждый сервис должен следовать единому паттерну:

```typescript
import { logger } from '../utils/logger';
import type { ServiceType } from '../types';

class ServiceName {
  private config: ServiceConfig;
  
  constructor(config: ServiceConfig) {
    this.config = config;
  }
  
  async initialize(): Promise<void> {
    logger.info('Initializing ServiceName...');
    // инициализация
  }
  
  async cleanup(): Promise<void> {
    logger.info('Cleaning up ServiceName...');
    // очистка ресурсов
  }
}

export const serviceName = new ServiceName(config);
```

## Основные сервисы

### BrowserService
- Управление экземплярами Puppeteer
- Пул браузеров для параллельной обработки
- Настройка viewport и таймаутов

### ScreenshotService
- Создание скриншотов страниц и элементов
- Поддержка множественных селекторов
- Обработка ошибок загрузки страниц

### OpenAIService
- Клиент для GPT-4 Vision API
- Обработка изображений и текста
- Управление токенами и лимитами

### TelegramService
- Инициализация Telegraf бота
- Обработка команд и сообщений
- Отправка уведомлений

### BatchSiteAnalyzer
- Координация анализа крипто-проектов
- Управление потоком обработки сайтов
- Сбор и агрегация результатов AI анализа

### SimpleScanner
- Простое сканирование URL для создания скриншотов
- Использует общие утилиты из selectorUtils.ts
- Интеграция с browserService.ts

## Общие утилиты

### selectorUtils.ts
Централизованные утилиты для работы с селекторами:

```typescript
import { createLocator, takeScreenshotWithSelector, setupPageForScreenshots, waitForPageLoad } from '../utils/selectorUtils';

// Создание локатора
const locator = createLocator(page, selector);

// Скриншот с селектором
const screenshot = await takeScreenshotWithSelector(page, selector);

// Настройка страницы
await setupPageForScreenshots(page);

// Ожидание загрузки
await waitForPageLoad(page);
```

## Принципы

1. **Единственная ответственность** - каждый сервис решает одну задачу
2. **Инициализация и очистка** - всегда предоставляйте методы initialize() и cleanup()
3. **Логирование** - логируйте важные операции
4. **Обработка ошибок** - обрабатывайте ошибки на уровне сервиса
5. **Типизация** - используйте строгие типы из [types/index.ts](mdc:src/types/index.ts)
6. **Переиспользование** - используйте общие утилиты вместо дублирования кода
7. **Единообразие** - все сервисы должны использовать browserService.ts для управления браузером